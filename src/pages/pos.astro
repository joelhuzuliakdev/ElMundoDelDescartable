---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Mostrador">
  <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 p-6">
    <div class="max-w-6xl mx-auto">
      <!-- Header -->
      <div class="bg-white rounded-xl shadow-lg p-6 mb-6 flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold text-slate-800">üßæ Mostrador</h1>
          <p class="text-slate-600">Carga pedidos y env√≠a a caja</p>
        </div>
        <a href="/admin" class="text-slate-600 hover:text-slate-800 transition-colors">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
          </svg>
        </a>
      </div>

      <div class="grid lg:grid-cols-3 gap-6">
        <!-- IZQUIERDA -->
        <div class="lg:col-span-2 space-y-6">

          <!-- CLIENTE -->
          <div class="bg-white rounded-xl shadow-lg p-6">
            <label class="block font-semibold mb-2">Cliente</label>
            <select id="cliente" class="w-full border-2 border-slate-200 p-3 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all">
              <option value="">Consumidor final</option>
            </select>
          </div>

          <!-- BUSCADOR -->
          <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="grid grid-cols-12 gap-3">
              <input id="codigo" placeholder="C√≥digo del producto"
                class="col-span-12 md:col-span-5 border-2 border-slate-200 p-3 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all">
              <input id="cantidad" type="number" value="1" min="1"
                class="col-span-6 md:col-span-2 border-2 border-slate-200 p-3 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all">
              <select id="tipo" class="col-span-6 md:col-span-3 border-2 border-slate-200 p-3 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition-all">
                <option value="menor">Menor</option>
                <option value="por50">x50</option>
                <option value="por100">x100</option>
                <option value="bulto">Bulto</option>
              </select>
              <button id="btnAgregar"
                class="col-span-12 md:col-span-2 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-all shadow-md">
                + Agregar
              </button>
            </div>
          </div>

          <!-- TICKET -->
          <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="bg-slate-700 p-3">
              <h2 class="text-white font-semibold">Ticket de Venta</h2>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-100">
                  <tr class="text-sm text-slate-600">
                    <th class="p-3 text-left">C√≥digo</th>
                    <th class="p-3 text-left">Producto</th>
                    <th class="p-3 text-center">Cant</th>
                    <th class="p-3 text-center">Tipo</th>
                    <th class="p-3 text-right">Precio</th>
                    <th class="p-3 text-right">Subtotal</th>
                    <th class="p-3"></th>
                  </tr>
                </thead>
                <tbody id="ticket"></tbody>
              </table>
              <div id="emptyTicket" class="p-8 text-center text-slate-400">
                <svg class="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                </svg>
                <p class="font-medium">Ticket vac√≠o</p>
                <p class="text-sm">Agrega productos para comenzar</p>
              </div>
            </div>
          </div>
        </div>

        <!-- DERECHA -->
        <div class="space-y-6">
          <div class="bg-gradient-to-br from-green-600 to-green-700 text-white rounded-xl p-6 shadow-lg">
            <div class="text-sm opacity-90 mb-1">Total a pagar</div>
            <div class="text-4xl font-bold">$<span id="total">0.00</span></div>
            <div class="text-sm opacity-90 mt-2">
              <span id="itemCount">0</span> art√≠culos
            </div>
          </div>

          <button id="btnEnviar"
            class="w-full bg-orange-600 hover:bg-orange-700 text-white font-semibold rounded-xl p-4 shadow-md transition-all flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
            Enviar pedido a caja
          </button>

          <button id="btnLimpiar"
            class="w-full bg-slate-200 hover:bg-slate-300 text-slate-700 font-semibold rounded-xl p-3 transition-all flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            Limpiar ticket
          </button>
        </div>
      </div>
    </div>
  </div>
</Layout>

<script>
let productos = JSON.parse(localStorage.getItem("productos") || "[]");
let clientes = JSON.parse(localStorage.getItem("clientes") || "[]");
let ticket = [];

const clienteSelect = document.getElementById("cliente");
const codigoInput = document.getElementById("codigo");
const btnAgregar = document.getElementById("btnAgregar");
const btnEnviar = document.getElementById("btnEnviar");
const btnLimpiar = document.getElementById("btnLimpiar");

document.addEventListener("DOMContentLoaded", () => {
  renderClientes();
  btnAgregar.addEventListener("click", add);
  btnLimpiar.addEventListener("click", limpiarTicket);
  btnEnviar.addEventListener("click", enviarPedido);
  codigoInput.addEventListener("keypress", e => { if (e.key==="Enter") add(); });
  render();
});

function renderClientes() {
  clienteSelect.innerHTML = `<option value="">Consumidor final</option>`;
  clientes.forEach(c => {
    clienteSelect.innerHTML += `<option value="${c.id}">${c.nombre} (${c.descuento}%)</option>`;
  });
}

function getPrecioProducto(p, tipo) {
  // Manejar formato nuevo
  if (p.precios) {
    switch(tipo) {
      case "menor": return Number(p.precios.menor) || 0;
      case "por50": return Number(p.precios.por50) || Number(p.precios.menor) || 0;
      case "por100": return Number(p.precios.por100) || Number(p.precios.menor) || 0;
      case "bulto": return Number(p.precios.bulto) || Number(p.precios.mayor) || 0;
      default: return Number(p.precios.menor) || 0;
    }
  }
  // Compatibilidad con formato antiguo
  if (tipo === "bulto" || tipo === "mayor") {
    return Number(p.mayor) || 0;
  }
  return Number(p.menor) || 0;
}

function getTipoLabel(tipo) {
  const labels = {
    menor: "Menor",
    por50: "x50",
    por100: "x100",
    bulto: "Bulto"
  };
  return labels[tipo] || tipo;
}

function add() {
  const codigo = codigoInput.value.trim();
  const cant = Number(document.getElementById("cantidad").value);
  const tipo = document.getElementById("tipo").value;
  
  if (!codigo) return showNotification("Ingresa un c√≥digo","error");
  
  const p = productos.find(prod=>String(prod.codigo).toLowerCase()===codigo.toLowerCase());
  if (!p) return showNotification(`Producto con c√≥digo "${codigo}" no existe`,"error");
  
  // Obtener descuento del cliente
  let descuento = 0;
  const clienteId = clienteSelect.value;
  if(clienteId) {
    const cl = clientes.find(c=>c.id==clienteId);
    if(cl) descuento = cl.descuento || 0;
  }
  
  // Obtener precio seg√∫n tipo
  let precio = getPrecioProducto(p, tipo);
  
  // Validar que el precio exista
  if (precio === 0) {
    return showNotification(`Este producto no tiene precio para "${getTipoLabel(tipo)}"`, "error");
  }
  
  // Aplicar descuento
  precio -= precio * descuento / 100;
  
  // Buscar si ya existe en el ticket
  const existe = ticket.find(t => t.codigo === codigo && t.tipo === tipo);
  
  if(existe) {
    existe.cantidad += cant;
    existe.subtotal = existe.cantidad * precio;
  } else {
    ticket.push({
      codigo,
      nombre: p.nombre,
      cantidad: cant,
      tipo,
      precio,
      subtotal: cant * precio
    });
  }
  
  showNotification(`${p.nombre} agregado al ticket`, "success");
  codigoInput.value = "";
  document.getElementById("cantidad").value = "1";
  codigoInput.focus();
  render();
}

function render() {
  const tbody = document.getElementById("ticket");
  const emptyTicket = document.getElementById("emptyTicket");
  let total = 0, itemCount = 0;
  tbody.innerHTML = "";
  
  if(ticket.length === 0) {
    emptyTicket.style.display = "block";
  } else {
    emptyTicket.style.display = "none";
    
    ticket.forEach((t, i) => {
      total += t.subtotal;
      itemCount += t.cantidad;
      
      const tipoColors = {
        menor: 'bg-slate-100 text-slate-700',
        por50: 'bg-blue-100 text-blue-700',
        por100: 'bg-green-100 text-green-700',
        bulto: 'bg-purple-100 text-purple-700'
      };
      
      const colorClass = tipoColors[t.tipo] || 'bg-slate-100 text-slate-700';
      
      tbody.innerHTML += `<tr class="hover:bg-slate-50 transition-colors">
        <td class="p-3"><span class="font-mono text-sm bg-slate-100 px-2 py-1 rounded">${t.codigo}</span></td>
        <td class="p-3 font-medium text-slate-800">${t.nombre}</td>
        <td class="p-3 text-center"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded font-semibold">${t.cantidad}</span></td>
        <td class="p-3 text-center"><span class="px-2 py-1 rounded text-xs font-semibold ${colorClass}">${getTipoLabel(t.tipo)}</span></td>
        <td class="p-3 text-right text-slate-700">$${t.precio.toFixed(2)}</td>
        <td class="p-3 text-right font-semibold text-slate-800">$${t.subtotal.toFixed(2)}</td>
        <td class="p-3">
          <button onclick="removeItem(${i})" class="text-red-600 hover:text-red-800 hover:bg-red-50 p-2 rounded transition-all" title="Eliminar">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
          </button>
        </td>
      </tr>`;
    });
  }
  
  document.getElementById("total").innerText = total.toFixed(2);
  document.getElementById("itemCount").innerText = itemCount;
}

window.removeItem = i => {
  ticket.splice(i, 1);
  render();
};

function limpiarTicket() {
  if(ticket.length === 0) return showNotification("El ticket ya est√° vac√≠o","error");
  if(confirm("¬øLimpiar todo el ticket?")) {
    ticket = [];
    render();
    showNotification("Ticket limpiado","success");
  }
}

function enviarPedido() {
  if(ticket.length === 0) return showNotification("El ticket est√° vac√≠o","error");

  const clienteId = clienteSelect.value;
  const clienteNombre = clienteId ? clienteSelect.options[clienteSelect.selectedIndex].text : "Consumidor final";

  // Guardar pedido pendiente para la caja (admin)
  let pendientes = JSON.parse(localStorage.getItem("pedidosPendientes") || "[]");
  pendientes.push({
    items: [...ticket],
    clienteId,
    clienteNombre,
    fecha: new Date().toISOString()
  });
  localStorage.setItem("pedidosPendientes", JSON.stringify(pendientes));

  // Limpiar ticket del empleado
  ticket = [];
  render();

  // Solo mostrar notificaci√≥n, NO redirigir
  showNotification("‚úÖ Pedido enviado a caja (solo admin puede cobrar)", "success");
}

function showNotification(message, type) {
  const n = document.createElement("div");
  n.className = `fixed top-4 right-4 px-6 py-4 rounded-lg shadow-xl text-white font-semibold z-50 transform transition-all duration-300 ${type==="success"?"bg-green-600":"bg-red-600"}`;
  n.textContent = message;
  document.body.appendChild(n);
  setTimeout(() => {
    n.style.opacity = "0";
    setTimeout(() => n.remove(), 300);
  }, 3000);
}
</script>